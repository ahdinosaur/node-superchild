<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for lib/superchild.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">lib/</a> superchild.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">85.92% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>61/71</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">59.26% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>16/27</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">84.62% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>11/13</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">88.41% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>61/69</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">//
// [![Circle CI](https://circleci.com/gh/mayanklahiri/node-superchild.svg?style=svg)](https://circleci.com/gh/mayanklahiri/node-superchild)
// [![GitHub issues](https://img.shields.io/github/issues/mayanklahiri/node-superchild.svg)](https://github.com/mayanklahiri/node-superchild/issues)
// [![GitHub license](https://img.shields.io/badge/license-MIT-blue.svg)](https://raw.githubusercontent.com/mayanklahiri/node-superchild/master/LICENSE)
// [![Twitter](https://img.shields.io/twitter/url/https/github.com/mayanklahiri/node-superchild.svg?style=social)](https://twitter.com/intent/tweet?text=Wow:&amp;url=%5Bobject%20Object%5D)
//
// # Superchild
//
// **Superchild** is a POSIX-only (e.g., Linux, Mac OS X) wrapper around
// node.js's built-in `child_process` module, which requires a lot of
// care and attention to use correctly.
//
// The purpose of Superchild is to allow large node.js programs
// to be split into independent processes (and sub-processes, resulting
// in **process trees**), while handling the tedious parts of process
// management and communication.
//
// Superchild also aims to be **compatible** with any program
// that reads from and writes to their `stdin`, `stdout`, and `stderr`
// streams, regardless of what language the program is written in.
// This allows interesting hacks like using `ssh` to execute a
// module, on a remote host, written in another language, and over an
// encrypted link, while using the near-universal format of line-delimited
// JSON messages over `stdio` for inter-process communication.
//
// **Features** that make Superchild different from node's built-in
// `child_process` module include the following (many of these
// are currently possible only due to restricting focus to POSIX
// platforms, i.e., not Windows):
//
//   1. A single function to replace `fork()`, `exec()`,
//      and `spawn()` from the built-in `child_process` module.
//
//   2. Waits for `stdout` and `stderr` streams to end before
//      emitting an `exit` event, unlike `child_process`.
//
//   3. Handle isolating child process and its children in a
//      separate, __detached process group__ that can be terminated
//      as a subtree using the POSIX `kill` command. This means
//      that calling `close()` on a Superchild instance will kill
//      not just the child process, but all _its_ child processes
//      and so on (i.e., the entire process group lead by the child).
//      Note that if any processes in the sub-tree detach themselves
//      into a new process group, they will not be part of our
//      child's process group, and will not be killed.
//
//   4. Handle __graceful termination__ of child's entire process group
//      using `SIGINT` -&gt; `SIGTERM` -&gt; `SIGKILL` signals with a
//      configurable timeout between each stage.
//
//   5. Handle __unexpected termination__ of current process by killing
//      the child's entire process group.
//
//   6. Automatically serialize and deserialize __line-delimited JSON__
//      values (LD-JSON) sent to and received from child, intermixed
//      with `stdout` and `stderr`. Demultiplex child's `stdout`
//      stream into `stdout_line` (parsed raw text lines), `json_object`
//      (parsed LD-JSON objects), and `json_array` (parsed LD-JSON
//      arrays) event streams. Regular processes have 3 I/O streams,
//      Superchildren have 5 streams!
//
// ### Install
//
//       npm install superchild
//
// ### Usage
//
// ##### Run a shell command
//
// Get a directory listing line-by-line using `ls`.
//
//       var superchild = require('superchild');
//       var child = superchild('find . | wc -l');
//       child.on('stdout_line', function(line) {
//         console.log('[stdout]: ', line);
//       });
//
// ##### Spawn and communicate with a module
//
// Spawn a node.js module in another process and communicate with it.
// Note that the child uses the `superchild.unlogger` helper function
// to parse its standard input for LD-JSON arrays and objects.
//
// _master.js_
//
//      var assert = require('assert');
//      var superchild = require('superchild');
//      var child = superchild('node echo.js');
//      child.send({
//        some: 'data',
//      });
//      child.on('json_object', function(jsonObj) {
//        assert.equal(jsonObj.some, 'data');
//      });
//
// _echo.js_
//
//      var unlogger = require('superchild').unlogger;
//      unlogger.start().on('json_object', function(jsonObj) {
//        // Echo JSON object from parent back to parent.
//        unlogger.send(jsonObj);
//      });
//
//
// ### Events emitted
//
// Superchild is an EventEmitter. The following events can be listened for
// using `child.on()` and `child.once()` functions.
//
// | Event          | Arguments                | Description                                             |
// | ---------------| -------------------------|---------------------------------------------------------|
// | `exit`         | `code`, `signal`         | Child process exited, identical to `child_process.exit` |
// | `stderr_data`  | `dataStr`                | Received unbuffered data on child's `stderr` stream.    |
// | `stdout_line`  | `lineStr`                | Received a full line of text from the child process.    |
// | `json_object`  | `jsonObj`                | Parsed a line-delimited JSON object from child's `stdout` stream. |
// | `json_array`   | `jsonArr`                | Parsed a line-delimited JSON array from child's `stdout` stream.  |
//
// ### Methods
//
// | Method          | Description                                                                    |
// | ----------------| -------------------------------------------------------------------------------|
// | `send(jsonVal)` | Serialize and send a JSON-serializable object or array to the child as LD-JSON.|
// | `close(cb)`     | Gracefully terminate the child, invoking the callback when the child has died. |
//
// ### Requirements
//
//   * `node.js` version 0.11.13 or higher, due to the use of `spawnSync`.
//   * POSIX-compliant platform, such as Linux or Mac OS.
//
/** @license The MIT License, Copyright (c) 2016 Mayank Lahiri &lt;mayank@iceroad.io&gt; */
var events = require('events')
  , fmt = require('util').format
  , fs = require('fs')
  , spawn = require('child_process').spawn
  , spawnSync = require('child_process').spawnSync
  , JSONSieve = require('./json-sieve')
  ;
&nbsp;
&nbsp;
module.exports = function superchild(commandLine, options) {
  <span class="missing-if-branch" title="if path not taken" >I</span>if (!commandLine) <span class="cstat-no" title="statement not covered" >throw new Error('Superchild: empty commandLine provided.');</span>
  options = (typeof options == 'object' ? <span class="branch-0 cbranch-no" title="branch not covered" >options </span>: {});
  var opt = {}, setDefault = function(key, defaultVal) {
    opt[key] = (key in options) ? <span class="branch-0 cbranch-no" title="branch not covered" >options[key] </span>: defaultVal;
  };
&nbsp;
  // #### Default options
  //
  //   * **`stringEncoding`**: character encoding to use while communicating
  //   with the child. This is required to make node.js return strings instead
  //   of raw buffers. Defaults to **utf-8**.
  setDefault('stringEncoding', 'utf-8');
&nbsp;
  //   * **`killOnExit`**: kill child process group when our own process
  //   exits, if the child is still running. Defaults to **true**.
  setDefault('killOnExit', true);
&nbsp;
  //   * **`cleanupTimeoutMs`**: amount of walltime to wait for child process
  //     to exit after `close()` is called, before sending it SIGTERM. Defaults
  //     to **500ms**.
  setDefault('cleanupTimeoutMs', 500);
&nbsp;
  //   * **`shell`**: run the command line through a system shell, defaults
  //     to **true**.
  setDefault('shell', true);
&nbsp;
  // Construct an `EventEmitter` instance to return to the caller. This
  // is a proxy emitter for the child process so that we can
  // re-order events received from the child process if necessary.
  var emitter = new events.EventEmitter();
&nbsp;
  // #### Spawning the child process
  //
  // Spawn a child process with the `detached` option makes it
  // the leader of its own process group. This allows us to
  // terminate all its descendant processes (if we need to) by running
  // `kill -$PGID` (negation of the child's process group id).
  //
  var child;
  try {
    child = spawn(commandLine, {
      detached: true,
      shell: opt.shell,
      stdio: 'pipe',
    });
    child.stdin.setDefaultEncoding(opt.stringEncoding);
    child.stdout.setEncoding(opt.stringEncoding);
    child.stderr.setEncoding(opt.stringEncoding);
    <span class="missing-if-branch" title="if path not taken" >I</span>if (!child.pid) {
<span class="cstat-no" title="statement not covered" >      throw new Error('child did not have a process id.');</span>
    }
    emitter.pid = child.pid;
  } catch(e) {
<span class="cstat-no" title="statement not covered" >    throw new Error(fmt(</span>
        'superchild: cannot spawn() child process, reason=%s',
        e.message));
  }
&nbsp;
  // #### Reading from the child
  //
  // Read from the child process by parsing out complete lines and line-delimited
  // JSON objects and arrays from its `stdout` stream using `JSONSieve`.
  var sieve = new JSONSieve();
  child.stdout.on('data', function(dataStr) {
    sieve.observe(dataStr);
  });
  sieve.on('json_object', emitter.emit.bind(emitter, 'json_object'));
  sieve.on('json_array', emitter.emit.bind(emitter, 'json_array'));
  sieve.on('stdout_line', emitter.emit.bind(emitter, 'stdout_line'));
  child.stderr.on('data', emitter.emit.bind(emitter, 'stderr_data'));
&nbsp;
  // #### Writing to the child: `send()`
  //
  var outbox = [];
  emitter.send = function(jsonVal) {
    <span class="missing-if-branch" title="else path not taken" >E</span>if (child &amp;&amp; child.pid) {
      var ser = JSON.stringify(jsonVal) + '\n';
      child.stdin.write(ser);
    } else {
<span class="cstat-no" title="statement not covered" >      throw new Error('Unable to write to process.');</span>
    }
  };
&nbsp;
  // #### Terminating the child: `close()`
  //
  // Kill the child's process group gracefully. This involves the following
  // steps:
  //
  //   1. Send a `SIGINT` signal to the child process only.
  //   2. Wait for `opt.cleanupTimeoutMs` milliseconds.
  //   3. Send a `SIGTERM` signal to the child's entire process group.
  //
  // This method is a public method that is offered
  // via the return value of the `superchild()` call.
  //
  // Note that we wait for the proxy emitter's `exit` event before invoking
  // the callback rather than the underlying child process's `exit` event.
  // This is in order to wait for all output streams to flush before
  // actually emitting the `exit` event.
  //
  emitter.close = function(cb) {
    cb = cb || function() {};
    <span class="missing-if-branch" title="if path not taken" >I</span>if (!child.pid) <span class="cstat-no" title="statement not covered" >throw new Error('superchild: child is not running.');</span>
    var killChildCmdLine = fmt('/bin/kill -SIGHUP -- %d', child.pid);
    var killGroupCmdLine = fmt('/bin/kill -SIGTERM -- -%d', child.pid);
    spawnSync(killChildCmdLine, {shell: true, stdio: 'inherit'});
    setTimeout(<span class="fstat-no" title="function not covered" >function() {</span>
<span class="cstat-no" title="statement not covered" >      if (child.pid) {</span>
<span class="cstat-no" title="statement not covered" >        spawnSync(killGroupCmdLine, {shell: true, stdio: 'inherit'});</span>
      }
    }, opt.cleanupTimeoutMs);
    emitter.once('exit', cb);
    child.stdin.close();
  };
&nbsp;
&nbsp;
  // #### Cleaning up the child process
  //
  // If the `killOnExit` option is specified, then when our own
  // current process exits, kill the child's process group using
  // the POSIX `kill` command with the child's process group ID,
  // which is the negation of its process id, since it is the leader
  // of its own process group.
  //
  <span class="missing-if-branch" title="else path not taken" >E</span>if (opt.killOnExit) {
    process.once('exit', <span class="fstat-no" title="function not covered" >function() {</span>
<span class="cstat-no" title="statement not covered" >      if (child.pid) {</span>
<span class="cstat-no" title="statement not covered" >        var killCmdLine = fmt('kill -SIGTERM -- -%d', child.pid);</span>
<span class="cstat-no" title="statement not covered" >        spawnSync(killCmdLine, {shell: true});</span>
      }
    });
  }
&nbsp;
  // If the child exits, then we need to wait for its streams to
  // close as well, and then flush the JSON sieve before emitting
  // the 'exit' event through the proxy emitter.
  var hasExited = false, stdoutEnded = false, stderrEnded = false;
  var exitCode, exitSignal;
  var cleanupFn = function() {
    if (hasExited &amp;&amp; stdoutEnded &amp;&amp; stderrEnded) {
      sieve.close(function() {
        emitter.emit('exit', exitCode, exitSignal);
      });
    }
  };
  child.stdout.once('end', function() {
    stdoutEnded = true;
    cleanupFn();
  });
  child.stderr.once('end', function() {
    stderrEnded = true;
    cleanupFn();
  });
  child.once('exit', function(code, signal) {
    exitCode = code;
    exitSignal = signal;
    hasExited = true;
    delete child.pid;
    cleanupFn();
  });
&nbsp;
&nbsp;
  // #### Return value
  //
  // The `superchild()` call returns a proxy `EventEmitter` with two
  // additional methods that are used to control the child process:
  // `close()` and `send()`.
  return emitter;
};
&nbsp;
//
// See current test coverage report at [coverage/lib/index.html](http://mayanklahiri.github.io/node-superchild/coverage/lib/index.html),
// generated using [Istanbul](https://github.com/gotwarlost/istanbul).
//
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Wed Apr 27 2016 15:34:20 GMT-0700 (PDT)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
